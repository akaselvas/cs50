{% extends "layout.html" %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<div class="insideResult">
    <div id="content-wrapper" class="content-wrapper">
        <div class="txt-resultado">
            <p id="loading-message">
                Estamos gerando sua leitura. Por favor, aguarde
                <span class="loading-dots">
                    .<span>.</span><span>.</span><span>.</span>
                </span>
            </p>
            <div id="result-area" style="display:none;">
                <p id="tarot-reading"></p>
                <div class="container-botoes">
                    <button id="open-chat" type="button" class="botao-texto-grande">
                        quer conversar mais sobre a leitura?
                    </button>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
    </div>
    <div id="shadow-overlay" class="shadow-overlay" style="display: none;"></div>
    <div id="scroll-indicator" class="scroll-indicator" style="display: none;">
        <span>&#x2193;</span>
    </div>
</div>

<div id="chat-overlay" class="chat-overlay" style="display: none;"></div>

<div id="chat-interface" class="chat-interface" style="display: none;">
    <div class="chat-header">
        <h2>Chat sobre a leitura</h2>
        <button id="close-chat" class="close-button">&times;</button>
    </div>
    <div id="chat-messages" class="chat-messages">
        <!-- Messages will be added here dynamically -->
    </div>
    <div class="chat-input-area">
        <input type="text" id="user-input" class="chat-input" placeholder="Digite sua mensagem...">
        <button id="send-message" class="chat-send-button">Enviar</button>
    </div>
</div>

<!-- Incluindo o script do Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.18/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    console.log('Results page JavaScript initialized');
    
    // Logging socket events
    socket.on('connect', () => {
        console.log('Socket.IO connection established');
    });

    socket.on('connect_error', (error) => {
        console.error('Socket.IO connection error:', error);
    });
      

    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('Security token is missing. Please refresh the page.');
        return;
    }

    const choosedCardsData = JSON.parse(localStorage.getItem('choosedCardsData') || '[]');

    console.log('Preparing to emit start_generation with:', {
        intencao: "{{ intencao }}",
        selected_cards: "{{ selected_cards }}",
        choosed_cards: choosedCardsData,
        csrf_token: csrfToken
    });

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    const contentWrapper = document.getElementById('content-wrapper');
    const resultArea = document.getElementById('result-area');
    const shadowOverlay = document.getElementById('shadow-overlay');
    const scrollIndicator = document.getElementById('scroll-indicator');
    const chatInterface = document.getElementById('chat-interface');
    const chatOverlay = document.getElementById('chat-overlay');
    const openChatButton = document.getElementById('open-chat');
    const closeChatButton = document.getElementById('close-chat');
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendMessageButton = document.getElementById('send-message');
    let tarotReading = '';
    let isFirstChatOpen = true;

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // socket.emit('start_generation', {
    //     intencao: "{{ intencao }}",
    //     selected_cards: "{{ selected_cards }}",
    //     choosed_cards: {{ choosed_cards | tojson }},
    //     csrf_token: '{{ csrf_token() }}'
    // });

    socket.emit('start_generation', {
        intencao: "{{ intencao }}",
        selected_cards: "{{ selected_cards }}",
        choosed_cards: choosedCardsData,
        csrf_token: csrfToken
    });

    socket.on('generation_error', (data) => {
        console.error('Socket.IO generation error:', data);
        
        // Update UI to show error
        const resultArea = document.getElementById('result-area');
        const loadingMessage = document.getElementById('loading-message');
        
        if (resultArea) resultArea.style.display = 'block';
        if (loadingMessage) loadingMessage.innerHTML = `
            <div class="error-message">
                Erro na geração da leitura: ${data.message || 'Erro desconhecido'}
                <br>
                Por favor, tente novamente.
            </div>
        `;
    });

    socket.on('generation_complete', function(data) {
        console.log('Generation completed', data);

        const loadingMessage = document.getElementById('loading-message');
        const resultArea = document.getElementById('result-area');
        const tarotReading = document.getElementById('tarot-reading');

        if (loadingMessage) loadingMessage.style.display = 'none';
        if (resultArea) resultArea.style.display = 'block';
        
        if (tarotReading) {
            tarotReading.innerHTML = data.reading;
            
            // Additional check for empty reading
            if (!data.reading.trim()) {
                console.warn('Received empty reading');
                tarotReading.innerHTML = 'Não foi possível gerar a leitura. Por favor, tente novamente.';
            }
        }

        // Store tarot reading for chat context
        localStorage.setItem('tarotReading', data.reading);
    });

    const generationTimeout = setTimeout(() => {
        console.error('Generation request timed out');
        
        const loadingMessage = document.getElementById('loading-message');
        if (loadingMessage) {
            loadingMessage.innerHTML = `
                <div class="error-message">
                    A geração da leitura está demorando mais do que o esperado. 
                    <br>
                    Por favor, atualize a página ou tente novamente.
                </div>
            `;
        }
    }, 45000); // 45 seconds timeout

    // Clear timeout on successful generation
    socket.on('generation_complete', () => {
        clearTimeout(generationTimeout);
    });

    function checkContentOverflow() {
        if (resultArea.scrollHeight > contentWrapper.clientHeight) {
            showScrollIndicators();
        } else {
            hideScrollIndicators();
        }
    }

    function showScrollIndicators() {
        shadowOverlay.style.display = 'block';
        scrollIndicator.style.display = 'block';
    }

    function hideScrollIndicators() {
        shadowOverlay.style.display = 'none';
        scrollIndicator.style.display = 'none';
    }

    function isAtBottom() {
        const scrollTop = contentWrapper.scrollTop;
        const scrollHeight = contentWrapper.scrollHeight;
        const clientHeight = contentWrapper.clientHeight;
        const tolerance = 5; // pixels of tolerance

        return scrollTop + clientHeight >= scrollHeight - tolerance;
    }

    contentWrapper.addEventListener('scroll', function() {
        if (isAtBottom()) {
            hideScrollIndicators();
        } else if (resultArea.scrollHeight > contentWrapper.clientHeight) {
            showScrollIndicators();
        }
    });

    window.addEventListener('resize', checkContentOverflow);

    openChatButton.addEventListener('click', () => {
        chatInterface.style.display = 'flex';
        chatOverlay.style.display = 'block';
        
        if (isFirstChatOpen) {
            addMessage('bot', 'Olá, vamos conversar mais sobre sua leitura, o que você quer saber?');
            isFirstChatOpen = false;
        }
    });

    closeChatButton.addEventListener('click', () => {
        chatInterface.style.display = 'none';
        chatOverlay.style.display = 'none';
    });

    sendMessageButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // function sendMessage() {
    //     const message = userInput.value.trim();
    //     if (message) {
    //         addMessage('user', message);
    //         showLoadingIndicator();
    //         socket.emit('send_message', { message: message, tarot_reading: tarotReading });
    //         userInput.value = '';
    //     }
    // }

    function sendMessage() {
        const message = userInput.value.trim();
        if (message) {
            addMessage('user', message);
            showLoadingIndicator();
            
            // Retrieve tarot reading from localStorage
            const tarotReading = localStorage.getItem('tarotReading') || '';
            
            socket.emit('send_message', { 
                message: message, 
                tarot_reading: tarotReading 
            });
            userInput.value = '';
        }
    }

    socket.on('receive_message', (data) => {
        removeLoadingIndicator();
        addMessage('bot', data.message);
    });

    function showLoadingIndicator() {
        const loadingDiv = document.createElement('div');
        loadingDiv.classList.add('chat-message', 'bot-message');
        loadingDiv.innerHTML = `
            <div class="chat-message-content">
                <span class="loading-dots">
                    .<span>.</span><span>.</span><span>.</span>
                </span>
            </div>
        `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeLoadingIndicator() {
        const loadingIndicator = chatMessages.querySelector('.chat-message:last-child');
        if (loadingIndicator && loadingIndicator.querySelector('.loading-dots')) {
            loadingIndicator.remove();
        }
    }

    function addMessage(sender, content) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'bot-message');
        
        // Parse markdown for bot messages
        if (sender === 'bot') {
            content = marked.parse(content);
        }
        
        messageDiv.innerHTML = `<div class="chat-message-content">${content}</div>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

})
</script>
{% endblock %}